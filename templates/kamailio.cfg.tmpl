#!KAMAILIO
#### Global ####
debug=2
log_stderror=no
fork=yes
children=8
mpath="/usr/lib/x86_64-linux-gnu/kamailio/modules/"

# Listen / Advertise
listen=udp:{{SIP_LISTEN_ADDR}}:{{SIP_LISTEN_PORT}}
#!ifdef ADVERTISE_SET
advertise=udp:{{SIP_ADVERTISE_ADDR}}:{{SIP_LISTEN_PORT}}
#!endif

#### Modules ####
# Transaction engine MUST be before sl
loadmodule "tm.so"
loadmodule "tmx.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "sanity.so"
loadmodule "maxfwd.so"
loadmodule "pv.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "xlog.so"
loadmodule "ipops.so"

# kamcmd over FIFO
loadmodule "jsonrpcs.so"
modparam("jsonrpcs", "fifo_name", "/run/kamailio/kamailio_rpc.fifo")

# Longest-prefix map in memory only (populated by pull-routing.sh via kamcmd)
loadmodule "mtree.so"
# Define tree named 'dest' and store matched value in $avp(mtv)
modparam("mtree", "mtree", "name=dest")
modparam("mtree", "pv_value", "$avp(mtv)")

#### Routing ####
request_route {
    if (!sanity_check("1777","7")) exit;
    if (!mf_process_maxfwd_header("10")) { sl_send_reply("483","Too Many Hops"); exit; }

    # Keepalive
    if (is_method("OPTIONS") && uri==myself) { sl_send_reply("200","OK"); exit; }

    if (is_method("INVITE")) {
        # Carrier allow-list
        if (!( {{CARRIER_EXPR}} )) {
            xlog("L_WARN","Blocked INVITE from $si\n");
            sl_send_reply("403","Forbidden");
            exit;
        }

        if ($rU == $null || $rU == "") { sl_send_reply("484","Address Incomplete"); exit; }

        # Expect E.164; keep '+' and digits only
        $var(dst) = $(rU{re.subst,/[^+0-9]//g});

        # LPM lookup on 'dest' => $avp(mtv) = "f1" or "f2"
        if (!mt_match("dest", $var(dst), 0)) {
            xlog("L_NOTICE","No mtree match for $var(dst)\n");
            sl_send_reply("404","No route");
            exit;
        }

        if ($avp(mtv) == "f1") {
            $du = "{{F1_SIP}}";
        } else if ($avp(mtv) == "f2") {
            $du = "{{F2_SIP}}";
        } else {
            xlog("L_ERR","Unknown mtree target '$avp(mtv)'\n");
            sl_send_reply("500","Server Misconfig");
            exit;
        }

        record_route();
        if (!t_relay()) sl_reply_error();
        exit;
    }

    sl_send_reply("405","Method Not Allowed"); exit;
}
